<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: api/elearning/elearning.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: api/elearning/elearning.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var Subchapters = require('../../models/elearning/subchapters');
var Slides = require('../../models/elearning/slides');
var Questions = require('../../models/elearning/questions');
var Answers = require('../../models/elearning/answers');
var Users = require('../../models/user');
var ContentVerifier = require('../../modules/contentVerifier');

var async = require('async');
var Q = require('q');
/**
 * Elearning module.
 * @module elearningModule
 */

function getSlide(id, previous, next){
	// this handles the slide query
	// if previous or next is specified, the previous or next slide relative to the id will be retrieved
	// if the slide cannot not be found, the reject will be called with no params
	var deferred = Q.defer();
	ContentVerifier.getContentById(Slides,id,null,false,'enabled','').then(
			function(success){
				if(previous || next){
						Subchapters.findOne({listSlides: {$in: [id]}}, function(err, subchapter){
							if(err){
								deferred.reject(err);
							}else if(!subchapter){
								deferred.reject();
							}else{
								var cursor;
								if(next){
									cursor = Slides.find({_id: {$in: subchapter.listSlides}, order: {$gt: slide.order}}).sort({order: 1}).limit(1);
								}else{
									cursor = Slides.find({_id: {$in: subchapter.listSlides}, order: {$lt: slide.order}}).sort({order:-1}).limit(1);
								}
								cursor.exec(function(err, slides){
									if(err){
										deferred.reject(err);
									}else if(!slides[0]){
										deferred.reject();
									}else{
										deferred.resolve(slides[0]);
									}
								});
							}
						});
					}else{
						deferred.resolve(success);
					}
			},function(err){
				deferred.reject(err);
			}
	);
	return deferred.promise;
};

function getUserPoints(qaMap){
	var deferred = Q.defer();
	var userPoints = 0;
	//the qaMap will look like:
	//{
	//	id_question1: [id_anwers],
	//	id_question2: [id_anwers]
	//}
	//the async will iterate through each question and calculate the score
	async.forEachOf(qaMap,
		function calculateQuestionScore(answersIds, questionId, callback){
			Questions.findOne({_id: questionId}).exec(function(err, question){
				if(err){
					callback(err);
				}else if(!question){
					callback();
				}else{
					//find all the answers for the current question that are also
					//marked by the user
					Answers.find({$and: [{_id: {$in: question.answers}}, {_id: {$in: answersIds}}]}).select("+ratio").exec(function(err, answers){
						if(err){
							callback(err);
						}else{
							var score = 0;
							//calculate the score by adding the ratios
							for(var i=0; i&lt;answers.length; i++){
								if(typeof  answers[i].ratio === "number") {score += answers[i].ratio;}
							}
							if(score > 0) userPoints += score;
							callback();
						}
					});
				}
			});
		},
		function doneCalculatingScore(err){
			if(err){
				deferred.reject(err);
			}else{
				//calculate total score
				deferred.resolve(userPoints);
			}
	});
	return deferred.promise;
};

function getQuestionsMaxPoints(questionsIds){
	var deferred = Q.defer();
	getAnswersIds(questionsIds).then(
		function(answersIds){
			Answers.aggregate([
			    {$match: {_id: {$in: answersIds}, ratio: {$gt: 0}}},
			    {$group: {_id: null, sum: {$sum: "$ratio"}}}
			], function(err, result){
				if(err){
					deferred.reject(err);
				}else if(!result[0]){
					deferred.reject("No result");
				}else{
					deferred.resolve(result[0].sum);
				}
			});
		},
		function(err){
			deferred.reject(err);
		}
	);
	return deferred.promise;
}

function getAnswersIds(questionsIds){
	var deferred = Q.defer();
	Questions.distinct("answers", {_id: {$in: questionsIds}}, function(err, answers){
		if(err){
			deferred.reject(err);
		}else{
			deferred.resolve(answers);
		}
	});
	return deferred.promise;
}

function getSlideViews(user, slide_id){
	try{
		return user.elearning.slide[slide_id].views;
	}catch(ex){
		//this probably happens when trying to acccess a property of undefined
		//so we can assume that the user hasn't viewed the slide yet
		return 0;
	}
}

function userViewedSlide(slide_id, user){
	if(slide_id &amp;&amp; user){
		slide_id = slide_id.toString();
		Users.findOne({_id: user._id}, function(err, user){
			if(!err &amp;&amp; user){
				markSlideViewed(slide_id, user);
			}
		});
	}
};

function markSlideViewed(slide_id, user){
	var updateQuery = {$inc: {}};
	var upd = "elearning.slide."+slide_id+".views";
	updateQuery.$inc[upd] = 1;
	//console.log(updateQuery);
	Users.findAndModify({_id: user._id}, {}, updateQuery, {upsert: false}, function(err, user){
		if(err) console.log(err);
	});
}

module.exports = {
	/**
	 * Function that retrieves a slide and the previous/next slide
	 *
	 * @name getSlide
	 * @function
	 * @param {String} id - slide id
	 * @param {Boolean} previous - if we want the previous slide
	 * @param {Boolean} next - if we want the next slide
	 * @example
	 * var elearningModule = require(/path/to/elearning/module)
	 * elearningModule.getSlide("wdadwa1212r412f", true).then(
	 *      function(success){
     *
     *      },
	 *      function(error){
     *
     *      }
	 * );
	 */
	getSlide: getSlide,
	/**
	 * Function that calculates a user's score for a test slide
	 *
	 * @name getUserPoints
	 * @function
	 * @param {Object} qaMap - a map of questions and user's answers
	 * @example
	 * var elearningModule = require(/path/to/elearning/module)
	 * elearningModule.getUserPoints({qId : aId}).then(
	 *      function(success){
     *
     *      },
	 *      function(error){
     *
     *      }
	 * );
	 */
	getUserPoints: getUserPoints,
	/**
	 * Function that retrieves a max score for a test slide
	 *
	 * @name getQuestionsMaxPoints
	 * @function
	 * @param {Array} qIds - an array of question ids
	 * @example
	 * var elearningModule = require(/path/to/elearning/module)
	 * elearningModule.getQuestionsMaxPoints([qId1, qId2]).then(
	 *      function(success){
     *
     *      },
	 *      function(error){
     *
     *      }
	 * );
	 */
	getQuestionsMaxPoints: getQuestionsMaxPoints,
	/**
	 * Function that verifies if a user viewed a slide
	 *
	 * @name getSlideViews
	 * @function
	 * @param {Object} user - an user object
	 * @param {String} slideID - the id of the slide
	 * @example
	 * var elearningModule = require(/path/to/elearning/module)
	 * var isViewed = elearningModule.getSlideViews({}, slideID);
	 */
	getSlideViews: getSlideViews,
	/**
	 * Function that marks a slide as viewed
	 *
	 * @name userViewedSlide
	 * @function
	 * @param {Object} user - an user object
	 * @param {String} slideID - the id of the slide
	 * @example
	 * var elearningModule = require(/path/to/elearning/module)
	 * elearningModule.userViewedSlide({}, slideID);
	 */
	userViewedSlide: userViewedSlide
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-conferencesModule.html">conferencesModule</a></li><li><a href="module-contentVerifierModule.html">contentVerifierModule</a></li><li><a href="module-elearningModule.html">elearningModule</a></li><li><a href="module-errorModule.html">errorModule</a></li><li><a href="module-importJanuviaUsersModule.html">importJanuviaUsersModule</a></li><li><a href="module-mailerModule.html">mailerModule</a></li><li><a href="module-modelDateUpdatedModule.html">modelDateUpdatedModule</a></li><li><a href="module-mongoosasticIndexModule.html">mongoosasticIndexModule</a></li><li><a href="module-mongooseIndexModule.html">mongooseIndexModule</a></li><li><a href="module-newsletterModule.html">newsletterModule</a></li><li><a href="module-pushNotifications.html">pushNotifications</a></li><li><a href="module-scheduleModule.html">scheduleModule</a></li><li><a href="module-sessionStorage.html">sessionStorage</a></li><li><a href="module-successModule.html">successModule</a></li><li><a href="module-tokenAuth.html">tokenAuth</a></li><li><a href="module-userModule.html">userModule</a></li><li><a href="module-utilsModule.html">utilsModule</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Q">Q</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.1</a> on Fri Sep 30 2016 17:00:05 GMT+0300 (EEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
