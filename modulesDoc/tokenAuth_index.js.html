<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: tokenAuth/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: tokenAuth/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var jwt = require('jsonwebtoken');

var User = require('../../models/user');
var AnswerGivers = require('../../models/qa_answerGivers');

var Q = require('q');
var UserService = require('../user');

var UtilsModule = require('../utils');

var Config = require('../../../config/environment.js'),
    my_config = new Config();

/**
 * Token Authentication module.
 * @module tokenAuth
 */

var getTokenReq = function (req) {
    try{
        return req.headers.authorization.split(' ').pop();
    }catch(ex){
        return false;
    }
};

var signToken = function (profile) {
    return jwt.sign(profile, my_config.tokenSecret);
};

var getUserData = function (req) {
    var token = getTokenReq(req);
    return token?jwt.decode(token):{};
};

var formatTokenProfile = function (user) {
    return {
        _id: user._id,
        username: user.username,
        name: user.name,
        image_path: user.image_path,
        answerer: false,
        routing_role: user.routing_role
    };
};

var authenticateToken = function (username, password) {
    var deferred = Q.defer();
    //find user in database
    User.findOne({ 'username' :  UtilsModule.regexes.emailQuery(username)}).select("+account_expired +account_locked +enabled +password +state +routing_role").exec(function(err, user) {
        // if there are any errors, return error status
        if (err){
            deferred.reject({status: 403, message: "Forbidden"});
        }else{
            // if no user is found, return the message
            if (!user){
                deferred.reject({status: 401, message: "Wrong username/password"});
            }else{
                //check account not expired, not locked etc
                if(user.account_expired || user.account_locked || !user.enabled){
                    deferred.reject({status: 401, message: "Access not allowed"});
                }else{
                    //check password
                    if (!user.validPassword(password)){
                        deferred.reject({status: 401, message: "Wrong username/password"});
                    }else{
                        user.answerer = false;
                        var profile = formatTokenProfile(user);
                        //check if user is an answerer
                        AnswerGivers.findOne({id_user: user._id}, function (err, data) {
                            if(err){
                                deferred.reject({status: 500, message: err});
                            }else{
                                if(data){
                                    profile.answerer = true;
                                    profile.alias = data;
                                }
                                // We are sending the profile inside the token
                                var token = signToken(profile);
                                deferred.resolve({ token: token , profile: profile});
                            }
                        });
                    }
                }
            }
        }
    });
    return deferred.promise;
};

var refreshToken = function (req) {
    var deferred = Q.defer();
    try{
        var token = getTokenReq(req);
        if(token){
            var user_id = jwt.decode(token)._id;
            User.findOne({_id: user_id}, function (err, user) {
                if(err){
                    deferred.reject("Error at updateTokenData - get user");
                }else if(!user){
                    deferred.reject("Error at updateTokenData - user not found");
                }else{
                    var userProfile = formatTokenProfile(user);
                    token = signToken(userProfile);
                    deferred.resolve(token);
                }
            });
        }else{
            deferred.reject("Error at updateTokenData - token not found");
        }
    }catch(ex){
        deferred.reject("Error at updateTokenData - parse token");
    }
    return deferred.promise;
};

module.exports = {
    /**
     * Function that generates a token for an existing user on Staywell in order to access medic API
     *
     * @name authenticateToken
     * @function
     * @param {String} username - Email address of the user
     * @param {String} password - User's Password
     * @example
     * var tokenAuth = require(/path/to/tokenAuth/module)
     * tokenAuth.authenticateToken("user@test.com", "pass").then(
     *      function(success){
     *
     *      },
     *      function(error){
     *
     *      }
     * );
     */
    authenticateToken: authenticateToken,
    /**
     * Function that re-generates a token for an existing user on Staywell in order to access medic API
     *
     * @name refreshToken
     * @function
     * @param {String} Authorization HTTP header - A string containing the previous JWT token (like "Bearer js911ndwdwd")
     * @example
     * var tokenAuth = require(/path/to/tokenAuth/module)
     * tokenAuth.refreshToken().then(
     *      function(success){
     *
     *      },
     *      function(error){
     *
     *      }
     * );
     */
    refreshToken: refreshToken,
    /**
     * Function that decodes a JWT token and returns user data
     *
     * @name getUserData
     * @function
     * @param {String} Authorization HTTP header - A string containing the JWT token (like "Bearer js911ndwdwd")
     * @example
     * var tokenAuth = require(/path/to/tokenAuth/module)
     * var tokenAuth = utilsModule.getUserData();
     */
    getUserData: getUserData
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-errorModule.html">errorModule</a></li><li><a href="module-importJanuviaUsersModule.html">importJanuviaUsersModule</a></li><li><a href="module-mailerModule.html">mailerModule</a></li><li><a href="module-modelDateUpdatedModule.html">modelDateUpdatedModule</a></li><li><a href="module-mongoosasticIndexModule.html">mongoosasticIndexModule</a></li><li><a href="module-mongooseIndexModule.html">mongooseIndexModule</a></li><li><a href="module-newsletterModule.html">newsletterModule</a></li><li><a href="module-pushNotifications.html">pushNotifications</a></li><li><a href="module-scheduleModule.html">scheduleModule</a></li><li><a href="module-sessionStorage.html">sessionStorage</a></li><li><a href="module-successModule.html">successModule</a></li><li><a href="module-tokenAuth.html">tokenAuth</a></li><li><a href="module-userModule.html">userModule</a></li><li><a href="module-utilsModule.html">utilsModule</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.1</a> on Wed Sep 28 2016 13:42:43 GMT+0300 (EEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
