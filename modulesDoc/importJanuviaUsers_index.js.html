<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: importJanuviaUsers/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: importJanuviaUsers/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Created by andreimirica on 11.11.2015.
 */

/**
 * Import users for Januvia iPad application
 * @module importJanuviaUsersModule
 */

var JanuviaUsers = require('../../models/januvia/januvia_users');
var Counties = require('../../models/counties');
var async = require('async');
var Q = require('q');
var mongoose = require('mongoose');
var ObjectId = mongoose.Types.ObjectId;
var _ = require('underscore');

var DiacriticsToLetters = function(input,anotherChar){
    if(typeof input !== 'string') input = "";
    var defaultDiacriticsRemovalMap = [{
        'base': "A",
        'letters': /(&amp;#65;|&amp;#9398;|&amp;#65313;|&amp;#192;|&amp;#193;|&amp;#194;|&amp;#7846;|&amp;#7844;|&amp;#7850;|&amp;#7848;|&amp;#195;|&amp;#256;|&amp;#258;|&amp;#7856;|&amp;#7854;|&amp;#7860;|&amp;#7858;|&amp;#550;|&amp;#480;|&amp;#196;|&amp;#478;|&amp;#7842;|&amp;#197;|&amp;#506;|&amp;#461;|&amp;#512;|&amp;#514;|&amp;#7840;|&amp;#7852;|&amp;#7862;|&amp;#7680;|&amp;#260;|&amp;#570;|&amp;#11375;|[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F])/g
    }, {
        'base': "I",
        'letters': /(&amp;#73;|&amp;#9406;|&amp;#65321;|&amp;#204;|&amp;#205;|&amp;#206;|&amp;#296;|&amp;#298;|&amp;#300;|&amp;#304;|&amp;#207;|&amp;#7726;|&amp;#7880;|&amp;#463;|&amp;#520;|&amp;#522;|&amp;#7882;|&amp;#302;|&amp;#7724;|&amp;#407;|[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197])/g
    },  {
        'base': "S",
        'letters': /(&amp;#83;|&amp;#9416;|&amp;#65331;|&amp;#7838;|&amp;#346;|&amp;#7780;|&amp;#348;|&amp;#7776;|&amp;#352;|&amp;#7782;|&amp;#7778;|&amp;#7784;|&amp;#536;|&amp;#350;|&amp;#11390;|&amp;#42920;|&amp;#42884;|[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784])/g
    }, {
        'base': "T",
        'letters': /(&amp;#84;|&amp;#9417;|&amp;#65332;|&amp;#7786;|&amp;#356;|&amp;#7788;|&amp;#538;|&amp;#354;|&amp;#7792;|&amp;#7790;|&amp;#358;|&amp;#428;|&amp;#430;|&amp;#574;|&amp;#42886;|[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786])/g
    }, {
        'base': "a",
        'letters': /(&amp;#97;|&amp;#9424;|&amp;#65345;|&amp;#7834;|&amp;#224;|&amp;#225;|&amp;#226;|&amp;#7847;|&amp;#7845;|&amp;#7851;|&amp;#7849;|&amp;#227;|&amp;#257;|&amp;#259;|&amp;#7857;|&amp;#7855;|&amp;#7861;|&amp;#7859;|&amp;#551;|&amp;#481;|&amp;#228;|&amp;#479;|&amp;#7843;|&amp;#229;|&amp;#507;|&amp;#462;|&amp;#513;|&amp;#515;|&amp;#7841;|&amp;#7853;|&amp;#7863;|&amp;#7681;|&amp;#261;|&amp;#11365;|&amp;#592;|[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250])/g
    }, {
        'base': "i",
        'letters': /(&amp;#105;|&amp;#9432;|&amp;#65353;|&amp;#236;|&amp;#237;|&amp;#238;|&amp;#297;|&amp;#299;|&amp;#301;|&amp;#239;|&amp;#7727;|&amp;#7881;|&amp;#464;|&amp;#521;|&amp;#523;|&amp;#7883;|&amp;#303;|&amp;#7725;|&amp;#616;|&amp;#305;|[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131])/g
    }, {
        'base': "s",
        'letters': /(&amp;#115;|&amp;#9442;|&amp;#65363;|&amp;#347;|&amp;#7781;|&amp;#349;|&amp;#7777;|&amp;#353;|&amp;#7783;|&amp;#7779;|&amp;#7785;|&amp;#537;|&amp;#351;|&amp;#575;|&amp;#42921;|&amp;#42885;|&amp;#7835;|&amp;#383;|[\u0073\u24E2\uFF53\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B\u017F])/g
    }, {
        'base': "t",
        'letters': /(&amp;#116;|&amp;#9443;|&amp;#65364;|&amp;#7787;|&amp;#7831;|&amp;#357;|&amp;#7789;|&amp;#539;|&amp;#355;|&amp;#7793;|&amp;#7791;|&amp;#359;|&amp;#429;|&amp;#648;|&amp;#11366;|&amp;#42887;|[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787])/g
    }];

    for (var i = 0; i &lt; defaultDiacriticsRemovalMap.length; i++) {
        input = input.replace(defaultDiacriticsRemovalMap[i].letters, defaultDiacriticsRemovalMap[i].base);
    }
    if(anotherChar)
        input = input.replace(',','');
    return input;
};

function Capitalise(string, isName) {
    if(isName){
        var nameArray = string.split(" ");
        var newName = '';
        for(var i = 0; i &lt; nameArray.length; i++){
            var space;
            if( i == nameArray.length - 1)
             space = "";
            else
                space = " ";
            newName += nameArray[i].charAt(0).toUpperCase() + nameArray[i].slice(1).toLowerCase() + space;
        }
        newName = DiacriticsToLetters(newName,true);
        return newName;
    }else
        return DiacriticsToLetters(string.charAt(0).toUpperCase() + string.slice(1).toLowerCase());
}

function lowerString (string) {
    var newName = string;
    newName = DiacriticsToLetters(newName,true);
    newName = newName.toLowerCase().replace(/-/g,"").replace(/\s+/g, "");
    return newName;
};

var medic = 'Associated Contact';
var rep = 'Owner';
var workplace = 'Account';
var workplaceAddress = 'Account Address Address 1';
var city = 'Account Address City';
var county = 'County';

var mrObj = {};
mrObj.map = function(){
    emit(this._id,this.name);
};

mrObj.reduce = function (k, vals) {
    return "TBD";
};

mrObj.finalize = function (k, vals) {
    return vals.toLowerCase().replace("-","").replace(/\s+/g, "");
};

mrObj.out = {
    inline: 1
};

var formatCitiesArray = function(citiesArray){
    var deferred = Q.defer();
    var citiesFormatted = [];
    //find all group ids with non-specific content for user
    async.eachSeries(citiesArray, function(city, callback){
        var cityFormatted = {
            _id: city._id,
            name: city.name.toLowerCase().replace("-","").replace(/\s+/g, "")
        };
        citiesFormatted.push(cityFormatted);
        callback();
    }, function (err) {
        if(err){
            deferred.reject(err);
        }else{
            deferred.resolve(citiesFormatted);
        }
    });
    return deferred.promise;
};

var addRep = function(fakeNameRep, realNameRep, medId, arrayOfExistingUsers){
    var deferred = Q.defer();
    var checkRepFirst = _.findWhere(arrayOfExistingUsers, {value: fakeNameRep});
    if(checkRepFirst){
        JanuviaUsers.update({_id: ObjectId(checkRepFirst._id)}, {$addToSet: {users_associated: ObjectId(medId)}}, {upsert: false}, function (err, wres) {
            if(err){
                deferred.reject(err);
            }else{
                deferred.resolve();
            }
        });
    } else {
        var repToCreate = {};
        repToCreate['type'] = 'reprezentant';
        repToCreate.date_created = new Date();
        repToCreate.last_modified = new Date();
        repToCreate.users_associated = [];
        repToCreate.users_associated.push(ObjectId(medId));
        repToCreate.name = realNameRep;
        repToCreate.workplace = '';
        repToCreate.workplaceAddress = '';
        var toSaveRep = new JanuviaUsers(repToCreate);
        arrayOfExistingUsers.push({_id: toSaveRep._id, value : fakeNameRep});
        toSaveRep.save(function(err,resp){
            if(err)
            {
                deferred.reject(err);
            }
            else{
                deferred.resolve();
            }
        })
    }
    return deferred.promise;
};

var insertUsers = function(arrayOfData){
    var deferred = Q.defer();
    var UsersTemp = null;
    JanuviaUsers.mapReduce(mrObj,function(err,data,stats){
        if(err){
            deferred.reject(err);
        }
        else {
            UsersTemp = data;
            async.eachSeries(arrayOfData, function(item, callback){
                        var nameMedic = lowerString(item[medic]);
                        var nameRep = lowerString(item[rep]);
                        var CityName = lowerString(item[city]);
                        var realMed = Capitalise(item[medic],true);
                        var realRep = Capitalise(item[rep],true);
                        var checkMedic = _.findWhere(UsersTemp, {'value': nameMedic});
                        if(checkMedic){
                            addRep(nameRep, realRep, checkMedic._id, UsersTemp).then(
                                function(success){
                                    callback();
                                },
                                function (err) {
                                    callback(err);
                                }
                            );
                        } else{
                            //first we find the county
                            Counties.findOne({label: item[county]}).populate('citiesID').exec(function(err, foundCounty){
                                if(err || !foundCounty){
                                    callback('County not found / Error processing county field');
                                } else {
                                    formatCitiesArray(foundCounty.citiesID).then(
                                        function (citiesFormatted) {
                                            var checkCity = _.findWhere(citiesFormatted, {'name': CityName});
                                            if(!checkCity)
                                                callback('City not found!');
                                            else {
                                                var medicToCreate = {};
                                                medicToCreate.type = 'medic';
                                                medicToCreate.date_created = new Date();
                                                medicToCreate.last_modified = new Date();
                                                medicToCreate.users_associated = [];
                                                medicToCreate.name = realMed;
                                                medicToCreate.city = ObjectId(checkCity._id);
                                                medicToCreate.workplace = Capitalise(item[workplace],true);
                                                medicToCreate.workplaceAddress = Capitalise(item[workplaceAddress],true);
                                                var toSaveMed = new JanuviaUsers(medicToCreate);
                                                toSaveMed.save(function(err,respMed) {
                                                    if (err) {
                                                        callback(err);
                                                    }
                                                    else {
                                                        UsersTemp.push({_id: respMed._id, value: nameMedic});
                                                        addRep(nameRep, realRep, respMed._id, UsersTemp).then(
                                                            function(success){
                                                                callback();
                                                            },
                                                            function (err) {
                                                                callback(err);
                                                            }
                                                        );
                                                    }
                                                });
                                            }
                                        },
                                        function (err) {
                                            callback('Error while processing cities!');
                                        }
                                    );

                                }
                            });
                        }
                    }, function (err) {
                        if(err){
                            deferred.reject(err);
                        }else{
                            deferred.resolve();
                        }
                    });
            }

    });

    return deferred.promise;
};

module.exports = {
    /**
     * Import Januvia users
     *
     * @function
     * @name insertUsers
     * @param {Array} arrayOfData - the data imported from a XLSX document received from Staywell (the header of XLSX must contain the following headers: 'Associated Contact' (is the medic), 'Owner' (is the reprezentant), 'Account' (is the workplace),
     'Account Address Address 1' (is the workplace address), 'Account Address City' (the city of the medic), 'County' (the county of the medic))
     * @example
     * var importJanuviaUsers = require(/path/to/importJanuviaUsers/module)
     * importJanuviaUsers.insertUsers(dataFromXLSX).then(
     *      function(success){
     *
     *      },
     *      function(error){
     *
     *      }
     * );
     */
    insertUsers: insertUsers
};

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-errorModule.html">errorModule</a></li><li><a href="module-importJanuviaUsersModule.html">importJanuviaUsersModule</a></li><li><a href="module-mailerModule.html">mailerModule</a></li><li><a href="module-modelDateUpdatedModule.html">modelDateUpdatedModule</a></li><li><a href="module-mongoosasticIndexModule.html">mongoosasticIndexModule</a></li><li><a href="module-mongooseIndexModule.html">mongooseIndexModule</a></li><li><a href="module-newsletterModule.html">newsletterModule</a></li><li><a href="module-pushNotifications.html">pushNotifications</a></li><li><a href="module-scheduleModule.html">scheduleModule</a></li><li><a href="module-sessionStorage.html">sessionStorage</a></li><li><a href="module-successModule.html">successModule</a></li><li><a href="module-tokenAuth.html">tokenAuth</a></li><li><a href="module-userModule.html">userModule</a></li><li><a href="module-utilsModule.html">utilsModule</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.1</a> on Wed Sep 28 2016 13:42:43 GMT+0300 (EEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
